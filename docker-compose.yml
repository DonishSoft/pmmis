services:
  pmmis-web:
    build:
      context: ./src
      dockerfile: Dockerfile
    container_name: pmmis-web
    restart: unless-stopped
    ports:
      - "5080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=pmmis-db;Port=5432;Database=pmmis;Username=pmmis_user;Password=${DB_PASSWORD:-PmmisSecure123!}
    volumes:
      - pmmis-keys:/root/.aspnet/DataProtection-Keys
    depends_on:
      pmmis-db:
        condition: service_healthy
    networks:
      - pmmis-network

  pmmis-db:
    image: postgres:16-alpine
    container_name: pmmis-db
    restart: unless-stopped
    volumes:
      - pmmis-pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=pmmis
      - POSTGRES_USER=pmmis_user
      - POSTGRES_PASSWORD=${DB_PASSWORD:-PmmisSecure123!}
    ports:
      - "5433:5432"
    networks:
      - pmmis-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U pmmis_user -d pmmis" ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  pmmis-network:
    driver: bridge
    name: pmmis-network

volumes:
  pmmis-pgdata:
    name: pmmis-pgdata
  pmmis-keys:
    name: pmmis-keys
