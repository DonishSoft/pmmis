@model List<PMMIS.Domain.Entities.IndicatorValue>
@using PMMIS.Domain.Entities
@{
    var indicator = (Indicator)ViewBag.Indicator;
    var districts = (List<District>)ViewBag.Districts;
    var villages = (List<Village>)ViewBag.Villages;
    var geoVillages = ViewBag.GeoVillages as List<Village>;
    ViewData["Title"] = $"–ó–Ω–∞—á–µ–Ω–∏—è ‚Äî {indicator.Code}";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isYesNo = indicator.MeasurementType == MeasurementType.YesNo;
    var hasGeoData = indicator.GeoDataSource != GeoDataSource.None && geoVillages != null;

    // Helper to get geo value from a village
    decimal GetGeoValue(Village v)
    {
        return indicator.GeoDataSource switch
        {
            GeoDataSource.Population => v.PopulationCurrent,
            GeoDataSource.FemalePopulation => v.FemalePopulation,
            GeoDataSource.Households => v.HouseholdsCurrent,
            GeoDataSource.SchoolCount => v.Schools.Count,
            GeoDataSource.HealthFacilityCount => v.HealthFacilities.Count,
            GeoDataSource.SchoolStudents => v.Schools.Sum(s => s.TotalStudents),
            _ => 0
        };
    }

    string GetGeoSourceLabel()
    {
        return indicator.GeoDataSource switch
        {
            GeoDataSource.Population => "–ù–∞—Å–µ–ª–µ–Ω–∏–µ (—Ç–µ–∫—É—â–µ–µ)",
            GeoDataSource.FemalePopulation => "–ñ–µ–Ω—Å–∫–æ–µ –Ω–∞—Å–µ–ª–µ–Ω–∏–µ",
            GeoDataSource.Households => "–î–æ–º–æ—Ö–æ–∑—è–π—Å—Ç–≤–∞",
            GeoDataSource.SchoolCount => "–ö–æ–ª-–≤–æ —à–∫–æ–ª",
            GeoDataSource.HealthFacilityCount => "–ö–æ–ª-–≤–æ –º–µ–¥—É—á—Ä–µ–∂–¥–µ–Ω–∏–π",
            GeoDataSource.SchoolStudents => "–ö–æ–ª-–≤–æ —É—á–µ–Ω–∏–∫–æ–≤",
            _ => "‚Äî"
        };
    }

    string GetGeoSourceIcon()
    {
        return indicator.GeoDataSource switch
        {
            GeoDataSource.Population => "üèòÔ∏è",
            GeoDataSource.FemalePopulation => "üë©",
            GeoDataSource.Households => "üè†",
            GeoDataSource.SchoolCount => "üè´",
            GeoDataSource.HealthFacilityCount => "üè•",
            GeoDataSource.SchoolStudents => "üéì",
            _ => "üìä"
        };
    }
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</a></li>
            <li class="breadcrumb-item active">@indicator.Code</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-list-ol me-2"></i>–ó–Ω–∞—á–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞</h2>
            <p class="text-muted mb-0">
                <code>@indicator.Code</code> ‚Äî @indicator.NameRu
                @if (indicator.MeasurementType == MeasurementType.Percentage)
                {
                    <span class="badge bg-info ms-2">%</span>
                }
                else if (isYesNo)
                {
                    <span class="badge bg-warning text-dark ms-2">–î–∞/–ù–µ—Ç</span>
                }
                else
                {
                    <span class="badge bg-secondary ms-2">@indicator.Unit</span>
                }
            </p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Edit" asp-route-id="@indicator.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> –ö —Å–ø–∏—Å–∫—É
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* ===== GEOGRAPHIC DATA SECTION ===== *@
    @if (hasGeoData)
    {
        var grouped = geoVillages!
            .GroupBy(v => v.Jamoat.District)
            .OrderBy(g => g.Key.NameRu);
        var totalGeoValue = geoVillages!.Sum(v => GetGeoValue(v));

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-geo-alt-fill text-primary me-2"></i>
                    @GetGeoSourceIcon() –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: @GetGeoSourceLabel()
                </h5>
                <span class="badge bg-primary fs-6">–ò—Ç–æ–≥–æ: @totalGeoValue.ToString("N0")</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px">‚Ññ</th>
                            <th>–†–∞–π–æ–Ω</th>
                            <th>–î–∂–∞–º–æ–∞—Ç</th>
                            <th>–°–µ–ª–æ</th>
                            <th class="text-end">@GetGeoSourceLabel()</th>
                            <th class="text-center">–ó–æ–Ω–∞</th>
                            <th class="text-center">–í –ø—Ä–æ–µ–∫—Ç–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var geoIdx = 1;
                            string? lastDistrict = null;
                            string? lastJamoat = null;
                        }
                        @foreach (var districtGroup in grouped)
                        {
                            var districtTotal = districtGroup.Sum(v => GetGeoValue(v));
                            <tr class="table-primary">
                                <td colspan="4" class="fw-bold">
                                    <i class="bi bi-geo me-1"></i>@districtGroup.Key.NameRu
                                    <span class="badge bg-white text-primary ms-2">@districtGroup.Count() —Å—ë–ª</span>
                                </td>
                                <td class="text-end fw-bold">@districtTotal.ToString("N0")</td>
                                <td colspan="2"></td>
                            </tr>

                            @foreach (var jamoatGroup in districtGroup.GroupBy(v => v.Jamoat).OrderBy(g => g.Key.NameRu))
                            {
                                var jamoatTotal = jamoatGroup.Sum(v => GetGeoValue(v));
                                <tr class="table-secondary">
                                    <td></td>
                                    <td colspan="3" class="ps-4 fst-italic">
                                        ‚Ü≥ @jamoatGroup.Key.NameRu
                                        <span class="text-muted">(@jamoatGroup.Count() —Å—ë–ª)</span>
                                    </td>
                                    <td class="text-end fw-semibold">@jamoatTotal.ToString("N0")</td>
                                    <td colspan="2"></td>
                                </tr>

                                @foreach (var village in jamoatGroup.OrderBy(v => v.NameRu))
                                {
                                    var geoVal = GetGeoValue(village);
                                    <tr>
                                        <td class="text-muted">@(geoIdx++)</td>
                                        <td class="text-muted small">@districtGroup.Key.NameRu</td>
                                        <td class="text-muted small">@jamoatGroup.Key.NameRu</td>
                                        <td>@village.NameRu</td>
                                        <td class="text-end fw-bold text-primary">@geoVal.ToString("N0")</td>
                                        <td class="text-center">
                                            <span class="badge bg-@(village.Zone == "2D" ? "info" : "warning") bg-opacity-75">@village.Zone</span>
                                        </td>
                                        <td class="text-center">
                                            @if (village.IsCoveredByProject)
                                            {
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-x-circle text-muted"></i>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @* ===== SUMMARY CARDS ===== *@
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    @if (hasGeoData)
                    {
                        <h3 class="text-primary mb-0">@geoVillages!.Count</h3>
                        <small class="text-muted">–°—ë–ª –≤ –±–∞–∑–µ</small>
                    }
                    else
                    {
                        <h3 class="text-primary mb-0">@Model.Count</h3>
                        <small class="text-muted">–ó–Ω–∞—á–µ–Ω–∏–π</small>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    @if (hasGeoData)
                    {
                        var totalGeo = geoVillages!.Sum(v => GetGeoValue(v));
                        <h3 class="text-success mb-0">@totalGeo.ToString("N0")</h3>
                        <small class="text-muted">@GetGeoSourceLabel()</small>
                    }
                    else if (isYesNo)
                    {
                        var yesCount = Model.Count(v => v.BoolValue == true);
                        <h3 class="text-success mb-0">@yesCount</h3>
                        <small class="text-muted">–î–∞</small>
                    }
                    else
                    {
                        <h3 class="text-success mb-0">@(indicator.TargetValue?.ToString("N0") ?? "‚Äî")</h3>
                        <small class="text-muted">–¶–µ–ª–µ–≤–æ–µ</small>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    @if (isYesNo)
                    {
                        var noCount = Model.Count(v => v.BoolValue == false);
                        <h3 class="text-danger mb-0">@noCount</h3>
                        <small class="text-muted">–ù–µ—Ç</small>
                    }
                    else
                    {
                        <h3 class="text-success mb-0">@(indicator.TargetValue?.ToString("N0") ?? "‚Äî")</h3>
                        <small class="text-muted">–¶–µ–ª–µ–≤–æ–µ</small>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center">
                <div class="card-body">
                    <h3 class="text-info mb-0">@Model.Count</h3>
                    <small class="text-muted">–í–≤–µ–¥—ë–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Add value form -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é</h5>
        </div>
        <div class="card-body">
            <form asp-action="AddValue" method="post">
                <input type="hidden" name="IndicatorId" value="@indicator.Id" />
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label">–î–∞—Ç–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è <span class="text-danger">*</span></label>
                        <input type="date" name="MeasurementDate" class="form-control"
                               value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                    </div>

                    @if (isYesNo)
                    {
                        <div class="col-md-2">
                            <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ <span class="text-danger">*</span></label>
                            <select name="BoolValue" class="form-select" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                                <option value="true">‚úÖ –î–∞</option>
                                <option value="false">‚ùå –ù–µ—Ç</option>
                            </select>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-2">
                            <label class="form-label">–ó–Ω–∞—á–µ–Ω–∏–µ <span class="text-danger">*</span></label>
                            <input type="number" name="Value" class="form-control" step="any" required
                                   placeholder="0" />
                        </div>
                    }

                    <div class="col-md-2">
                        <label class="form-label">–†–∞–π–æ–Ω</label>
                        <select name="DistrictId" id="districtSelect" class="form-select">
                            <option value="">‚Äî –û–±—â–µ–µ ‚Äî</option>
                            @foreach (var d in districts)
                            {
                                <option value="@d.Id">@d.NameRu</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">–°–µ–ª–æ</label>
                        <select name="VillageId" id="villageSelect" class="form-select">
                            <option value="">‚Äî –í—Å–µ ‚Äî</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                        <input type="text" name="Notes" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." />
                    </div>

                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-lg me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Manual values table -->
    @if (Model.Any())
    {
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-table me-2"></i>–í–≤–µ–¥—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (@Model.Count)</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px">‚Ññ</th>
                            <th>–î–∞—Ç–∞</th>
                            <th class="text-end">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                            <th>–†–∞–π–æ–Ω</th>
                            <th>–°–µ–ª–æ</th>
                            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            <th style="width: 80px" class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ var idx = 1; }
                        @foreach (var val in Model)
                        {
                            <tr>
                                <td>@(idx++)</td>
                                <td>
                                    <i class="bi bi-calendar3 me-1 text-muted"></i>
                                    @val.MeasurementDate.ToString("dd.MM.yyyy")
                                </td>
                                <td class="text-end fw-bold">
                                    @if (isYesNo)
                                    {
                                        if (val.BoolValue == true)
                                        {
                                            <span class="badge bg-success">‚úÖ –î–∞</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">‚ùå –ù–µ—Ç</span>
                                        }
                                    }
                                    else if (indicator.MeasurementType == MeasurementType.Percentage)
                                    {
                                        @val.Value.ToString("N1")<text>%</text>
                                    }
                                    else
                                    {
                                        @val.Value.ToString("N0")
                                    }
                                </td>
                                <td>
                                    @if (val.District != null)
                                    {
                                        <span class="badge bg-primary">@val.District.NameRu</span>
                                    }
                                    else if (val.Village?.Jamoat?.District != null)
                                    {
                                        <span class="badge bg-outline-primary text-primary border">@val.Village.Jamoat.District.NameRu</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                                <td>
                                    @if (val.Village != null)
                                    {
                                        <span>@val.Village.NameRu</span>
                                        <small class="text-muted d-block">@val.Village.Jamoat?.NameRu</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrWhiteSpace(val.Notes))
                                    {
                                        <small>@val.Notes</small>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <form asp-action="DeleteValue" method="post" class="d-inline"
                                          onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ?')">
                                        <input type="hidden" name="id" value="@val.Id" />
                                        <input type="hidden" name="indicatorId" value="@indicator.Id" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
    // Filter villages by selected district
    const districtSelect = document.getElementById('districtSelect');
    const villageSelect = document.getElementById('villageSelect');
    const allVillages = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        villages.Select(v => new { v.Id, Name = v.NameRu, DistrictId = v.Jamoat.District.Id, Jamoat = v.Jamoat.NameRu })
    ));

    districtSelect.addEventListener('change', () => {
        const districtId = parseInt(districtSelect.value);
        villageSelect.innerHTML = '<option value="">‚Äî –í—Å–µ ‚Äî</option>';
        if (!districtId) return;

        const filtered = allVillages.filter(v => v.districtId === districtId);
        let currentJamoat = '';
        filtered.forEach(v => {
            if (v.jamoat !== currentJamoat) {
                const optGroup = document.createElement('optgroup');
                optGroup.label = v.jamoat;
                villageSelect.appendChild(optGroup);
                currentJamoat = v.jamoat;
            }
            const opt = document.createElement('option');
            opt.value = v.id;
            opt.textContent = v.name;
            villageSelect.lastElementChild.appendChild(opt);
        });
    });
</script>
}
