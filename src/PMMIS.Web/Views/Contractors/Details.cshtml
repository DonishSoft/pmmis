@model PMMIS.Domain.Entities.Contractor
@using PMMIS.Domain.Entities
@{
    ViewData["Title"] = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var permissionService = ViewContext.HttpContext.RequestServices.GetRequiredService<PMMIS.Web.Services.IPermissionService>();
    var canEdit = await permissionService.HasPermissionAsync(User, "Contractors", "edit");
    var totalContractAmount = Model.Contracts.Sum(c => c.FinalAmount);
    var totalPaid = Model.Contracts.Sum(c => c.PaidAmount);
}

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ü–æ–¥—Ä—è–¥—á–∏–∫–∏</a></li>
            <li class="breadcrumb-item active">@Model.Name</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-building me-2"></i>@Model.Name</h2>
            @if (!string.IsNullOrEmpty(Model.Country))
            {
                <p class="text-muted mb-0"><i class="bi bi-geo-alt me-1"></i>@Model.Country</p>
            }
        </div>
        <div class="d-flex gap-2">
            @if (canEdit)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
            }
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–ö–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</div>
                    <div class="fs-3 fw-bold text-primary">@Model.Contracts.Count</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    <div class="fs-3 fw-bold text-info">$@totalContractAmount.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–û–ø–ª–∞—á–µ–Ω–æ</div>
                    <div class="fs-3 fw-bold text-success">$@totalPaid.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–ö –æ–ø–ª–∞—Ç–µ</div>
                    <div class="fs-3 fw-bold text-warning">$@((totalContractAmount - totalPaid).ToString("N0"))</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Contracts List -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h5>
                    <span class="badge bg-secondary">@Model.Contracts.Count –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</span>
                </div>
                <div class="card-body p-0">
                    @if (Model.Contracts.Any())
                    {
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>–ù–æ–º–µ—Ä</th>
                                    <th>–û–±—ä—ë–º —Ä–∞–±–æ—Ç</th>
                                    <th>–¢–∏–ø</th>
                                    <th class="text-end">–°—É–º–º–∞ ($)</th>
                                    <th>–°—Ä–æ–∫</th>
                                    <th class="text-center">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var contract in Model.Contracts.OrderBy(c => c.SigningDate))
                                {
                                    <tr>
                                        <td>
                                            <a asp-controller="Contracts" asp-action="Details" asp-route-id="@contract.Id">
                                                @contract.ContractNumber
                                            </a>
                                        </td>
                                        <td>
                                            <span title="@contract.ScopeOfWork">
                                                @(contract.ScopeOfWork.Length > 60 ? contract.ScopeOfWork[..60] + "..." : contract.ScopeOfWork)
                                            </span>
                                        </td>
                                        <td>
                                            @switch (contract.Type)
                                            {
                                                case ContractType.Works:
                                                    <span class="badge bg-warning text-dark">–†–∞–±–æ—Ç—ã</span>
                                                    break;
                                                case ContractType.Consulting:
                                                    <span class="badge bg-info">–ö–æ–Ω—Å–∞–ª—Ç</span>
                                                    break;
                                                case ContractType.Goods:
                                                    <span class="badge bg-primary">–¢–æ–≤–∞—Ä—ã</span>
                                                    break;
                                            }
                                        </td>
                                        <td class="text-end fw-semibold">$@contract.FinalAmount.ToString("N0")</td>
                                        <td>
                                            <small>@contract.SigningDate.ToString("dd.MM.yyyy") ‚Äî @contract.ContractEndDate.ToString("dd.MM.yyyy")</small>
                                        </td>
                                        <td class="text-center">
                                            @if (contract.WorkCompletedPercent >= 100)
                                            {
                                                <span class="badge bg-success">100%</span>
                                            }
                                            else
                                            {
                                                <div class="progress" style="height: 20px; min-width: 60px;">
                                                    <div class="progress-bar bg-info" style="width: @contract.WorkCompletedPercent%">
                                                        @contract.WorkCompletedPercent%
                                                    </div>
                                                </div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            –ù–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Contact Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill me-2"></i>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.ContactPerson))
                    {
                        <p class="mb-2"><i class="bi bi-person me-2"></i>@Model.ContactPerson</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Email))
                    {
                        <p class="mb-2"><i class="bi bi-envelope me-2"></i><a href="mailto:@Model.Email">@Model.Email</a></p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Phone))
                    {
                        <p class="mb-2"><i class="bi bi-telephone me-2"></i>@Model.Phone</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Address))
                    {
                        <p class="mb-0"><i class="bi bi-geo me-2"></i>@Model.Address</p>
                    }
                    @if (string.IsNullOrEmpty(Model.ContactPerson) && string.IsNullOrEmpty(Model.Email) && string.IsNullOrEmpty(Model.Phone) && string.IsNullOrEmpty(Model.Address))
                    {
                        <p class="text-muted mb-0 text-center">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>
                    }
                </div>
            </div>

            <!-- Documents -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-folder me-2"></i>–î–æ–∫—É–º–µ–Ω—Ç—ã</h5>
                    @if (canEdit)
                    {
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocModal">
                            <i class="bi bi-upload me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                    }
                </div>
                <div class="card-body p-0">
                    @if (Model.Documents.Any())
                    {
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:40px">‚Ññ</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th class="text-end">–†–∞–∑–º–µ—Ä</th>
                                    @if (canEdit)
                                    {
                                        <th style="width:50px"></th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var doc in Model.Documents.OrderBy(d => d.SortOrder).ThenBy(d => d.CreatedAt))
                                {
                                    <tr>
                                        <td class="text-muted">@doc.SortOrder</td>
                                        <td>
                                            @{
                                                var (typeName, typeClass) = doc.Type switch
                                                {
                                                    DocumentType.CompanyRegistration => ("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", "bg-success"),
                                                    DocumentType.CompanyLicense       => ("–õ–∏—Ü–µ–Ω–∑–∏—è", "bg-info"),
                                                    DocumentType.TaxCertificate       => ("–ù–∞–ª–æ–≥–æ–≤—ã–π —Å–µ—Ä—Ç.", "bg-warning text-dark"),
                                                    DocumentType.BankDetails          => ("–ë–∞–Ω–∫. —Ä–µ–∫–≤–∏–∑–∏—Ç—ã", "bg-primary"),
                                                    DocumentType.Insurance            => ("–°—Ç—Ä–∞—Ö–æ–≤–∫–∞", "bg-danger"),
                                                    DocumentType.Contract             => ("–ö–æ–Ω—Ç—Ä–∞–∫—Ç", "bg-secondary"),
                                                    DocumentType.SignedContract        => ("–ü–æ–¥–ø. –∫–æ–Ω—Ç—Ä–∞–∫—Ç", "bg-dark"),
                                                    DocumentType.TenderDocument       => ("–¢–µ–Ω–¥–µ—Ä", "bg-info"),
                                                    DocumentType.Report               => ("–û—Ç—á—ë—Ç", "bg-primary"),
                                                    _                                 => ("–ü—Ä–æ—á–µ–µ", "bg-secondary")
                                                };
                                            }
                                            <span class="badge @typeClass" style="font-size: 0.7rem;">@typeName</span>
                                        </td>
                                        <td>
                                            <a href="@doc.FilePath" target="_blank" class="text-decoration-none">
                                                <i class="bi bi-file-earmark me-1"></i>@(doc.Description ?? doc.OriginalFileName)
                                            </a>
                                        </td>
                                        <td class="text-end text-muted small">
                                            @if (doc.FileSize > 1048576)
                                            {
                                                @($"{doc.FileSize / 1048576.0:F1} –ú–ë")
                                            }
                                            else
                                            {
                                                @($"{doc.FileSize / 1024.0:F0} –ö–ë")
                                            }
                                        </td>
                                        @if (canEdit)
                                        {
                                            <td>
                                                <form asp-action="DeleteDocument" method="post" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="documentId" value="@doc.Id" />
                                                    <input type="hidden" name="contractorId" value="@Model.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="–£–¥–∞–ª–∏—Ç—å">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-folder2-open fs-1 d-block mb-2"></i>
                            –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
@if (canEdit)
{
    <div class="modal fade" id="uploadDocModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="UploadDocuments" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="contractorId" value="@Model.Id" />
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞ <span class="text-danger">*</span></label>
                            <select name="documentType" class="form-select" required>
                                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø ‚Äî</option>
                                <option value="@((int)DocumentType.CompanyRegistration)">üìÑ –°–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</option>
                                <option value="@((int)DocumentType.CompanyLicense)">üìú –õ–∏—Ü–µ–Ω–∑–∏—è</option>
                                <option value="@((int)DocumentType.TaxCertificate)">üèõÔ∏è –ù–∞–ª–æ–≥–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</option>
                                <option value="@((int)DocumentType.BankDetails)">üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</option>
                                <option value="@((int)DocumentType.Insurance)">üõ°Ô∏è –°—Ç—Ä–∞—Ö–æ–≤–∫–∞</option>
                                <option value="@((int)DocumentType.Contract)">üìë –ö–æ–Ω—Ç—Ä–∞–∫—Ç</option>
                                <option value="@((int)DocumentType.SignedContract)">‚úçÔ∏è –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç</option>
                                <option value="@((int)DocumentType.TenderDocument)">üìã –¢–µ–Ω–¥–µ—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</option>
                                <option value="@((int)DocumentType.Report)">üìä –û—Ç—á—ë—Ç</option>
                                <option value="@((int)DocumentType.Other)">üìé –ü—Ä–æ—á–µ–µ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–§–∞–π–ª <span class="text-danger">*</span></label>
                            <input type="file" name="files" class="form-control" id="docFileInput" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                            <input type="text" name="description" class="form-control" id="docNameInput" placeholder="–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∏–º—è —Ñ–∞–π–ª–∞">
                            <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞</div>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-semibold">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                            <input type="number" name="sortOrder" class="form-control" value="@(Model.Documents.Any() ? Model.Documents.Max(d => d.SortOrder) + 1 : 1)" min="0">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
<script>
    // Auto-fill document name from file name
    document.getElementById('docFileInput')?.addEventListener('change', function() {
        var nameInput = document.getElementById('docNameInput');
        if (nameInput && !nameInput.value && this.files.length > 0) {
            var fileName = this.files[0].name;
            // Remove extension
            var lastDot = fileName.lastIndexOf('.');
            if (lastDot > 0) fileName = fileName.substring(0, lastDot);
            nameInput.value = fileName;
        }
    });
</script>
}

