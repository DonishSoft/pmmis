@model List<PMMIS.Domain.Entities.Contractor>
@{
    ViewData["Title"] = "Подрядчики";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var countries = Model.Where(c => !string.IsNullOrEmpty(c.Country)).Select(c => c.Country!).Distinct().OrderBy(c => c).ToList();
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-building me-2"></i>Подрядчики</h2>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Добавить подрядчика
        </a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Поиск</label>
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchFilter" placeholder="Название, контактное лицо или email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Страна</label>
                    <select class="form-select" id="countryFilter">
                        <option value="">— Все —</option>
                        @foreach (var country in countries)
                        {
                            <option value="@country">@country</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    <button class="btn btn-primary" onclick="applyFilters()" title="Применить фильтр">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
                <div class="col-auto">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()" title="Сбросить">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="col text-end">
                    <span class="text-muted">Найдено: <strong>@Model.Count</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Contractors Grid -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div id="contractorsGrid"></div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    try {
        var contractorData = @Html.Raw(Json.Serialize(Model.Select(c => new {
            c.Id,
            c.Name,
            Country = c.Country ?? "—",
            ContactPerson = c.ContactPerson ?? "—",
            Email = c.Email ?? "—",
            Phone = c.Phone ?? "—",
            ContractsCount = c.Contracts.Count
        })));

        var grid = new ej.grids.Grid({
            dataSource: contractorData,
            allowPaging: true,
            allowSorting: true,
            allowFiltering: true,
            allowExcelExport: true,
            allowPdfExport: true,
            pageSettings: { pageSize: 15 },
            filterSettings: { type: 'Excel' },
            toolbar: ['ExcelExport', 'PdfExport', 'Search'],
            columns: [
                {
                    field: 'name',
                    headerText: 'Название',
                    template: '<a href="/Contractors/Details/${id}" class="fw-bold text-decoration-none">${name}</a>',
                    width: 250
                },
                {
                    field: 'country',
                    headerText: 'Страна',
                    width: 140,
                    template: '<span><i class="bi bi-geo-alt me-1 text-muted"></i>${country}</span>'
                },
                {
                    field: 'contactPerson',
                    headerText: 'Контактное лицо',
                    width: 180,
                    template: '${if(contactPerson !== "—")}<i class="bi bi-person me-1 text-muted"></i>${contactPerson}${else}<span class="text-muted">—</span>${/if}'
                },
                {
                    field: 'email',
                    headerText: 'Email',
                    width: 200,
                    template: '${if(email !== "—")}<a href="mailto:${email}"><i class="bi bi-envelope me-1"></i>${email}</a>${else}<span class="text-muted">—</span>${/if}'
                },
                {
                    field: 'phone',
                    headerText: 'Телефон',
                    width: 150,
                    template: '${if(phone !== "—")}<i class="bi bi-telephone me-1 text-muted"></i>${phone}${else}<span class="text-muted">—</span>${/if}'
                },
                {
                    field: 'contractsCount',
                    headerText: 'Контрактов',
                    textAlign: 'Center',
                    width: 120,
                    template: '<span class="badge bg-info">${contractsCount}</span>'
                },
                {
                    headerText: 'Действия',
                    textAlign: 'Center',
                    width: 120,
                    template: '<a href="/Contractors/Details/${id}" class="btn btn-sm btn-outline-info me-1" title="Подробнее"><i class="bi bi-eye"></i></a><a href="/Contractors/Edit/${id}" class="btn btn-sm btn-outline-primary" title="Редактировать"><i class="bi bi-pencil"></i></a>'
                }
            ],
            toolbarClick: function(args) {
                if (args.item.id.includes('excelexport')) {
                    grid.excelExport({ fileName: 'Contractors_PMMIS.xlsx' });
                }
                if (args.item.id.includes('pdfexport')) {
                    grid.pdfExport({ fileName: 'Contractors_PMMIS.pdf' });
                }
            }
        });
        grid.appendTo('#contractorsGrid');
    } catch (e) {
        console.error('[PMMIS] Grid error:', e);
        document.getElementById('contractorsGrid').innerHTML =
            '<div class="alert alert-danger">Ошибка инициализации таблицы: ' + e.message + '</div>';
    }

    function applyFilters() {
        grid.clearFiltering();
        var search = document.getElementById('searchFilter').value.trim();
        var country = document.getElementById('countryFilter').value;
        
        if (search) {
            grid.search(search);
        }
        if (country) {
            grid.filterByColumn('country', 'equal', country);
        }
    }

    function clearFilters() {
        document.getElementById('searchFilter').value = '';
        document.getElementById('countryFilter').value = '';
        grid.clearFiltering();
        grid.searchSettings.key = '';
        grid.search('');
    }

    document.getElementById('searchFilter').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') applyFilters();
    });
</script>
}
