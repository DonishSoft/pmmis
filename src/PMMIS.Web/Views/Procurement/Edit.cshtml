@model PMMIS.Domain.Entities.ProcurementPlan
@using PMMIS.Domain.Entities
@{
    ViewData["Title"] = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ü–ª–∞–Ω –∑–∞–∫—É–ø–æ–∫</a></li>
            <li class="breadcrumb-item active">@Model.ReferenceNo</li>
        </ol>
    </nav>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-10">
            <form asp-action="Edit" method="post">
                <div asp-validation-summary="All" class="text-danger mb-3"></div>
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="CreatedAt" />

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">–†–µ—Ñ–µ—Ä–µ–Ω—Å –Ω–æ–º–µ—Ä <span class="text-danger">*</span></label>
                                <input type="text" asp-for="ReferenceNo" class="form-control" required />
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                                <input type="text" asp-for="Description" class="form-control" required />
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label class="form-label">üáπüáØ –¢–∞–≤—Å–∏—Ñ (—Ç–æ“∑–∏–∫”£) <span class="text-muted small">‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</span></label>
                                <input type="text" asp-for="DescriptionTj" class="form-control" placeholder="–¢–∞–≤—Å–∏—Ñ–∏ —Ö–∞—Ä–∏–¥ –±–æ –∑–∞–±–æ–Ω–∏ —Ç–æ“∑–∏–∫”£" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">üá¨üáß Description (English) <span class="text-muted small">‚Äî optional</span></label>
                                <input type="text" asp-for="DescriptionEn" class="form-control" placeholder="Procurement description in English" />
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label class="form-label">–ü—Ä–æ–µ–∫—Ç</label>
                                <select asp-for="ProjectId" asp-items="ViewBag.Projects" class="form-select" id="projectSelect">
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç</label>
                                <select asp-for="ComponentId" asp-items="ViewBag.Components" class="form-select" id="componentSelect">
                                    <option value="">‚Äî –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ü–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç</label>
                                <select asp-for="SubComponentId" asp-items="ViewBag.SubComponents" class="form-select" id="subComponentSelect">
                                    <option value="">‚Äî –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label">–ú–µ—Ç–æ–¥ –∑–∞–∫—É–ø–∫–∏</label>
                                <select asp-for="Method" class="form-select">
                                    <option value="@((int)ProcurementMethod.NCB)">NCB</option>
                                    <option value="@((int)ProcurementMethod.ICB)">ICB</option>
                                    <option value="@((int)ProcurementMethod.Shopping)">Shopping</option>
                                    <option value="@((int)ProcurementMethod.DirectContracting)">Direct Contracting</option>
                                    <option value="@((int)ProcurementMethod.CQS)">CQS</option>
                                    <option value="@((int)ProcurementMethod.QCBS)">QCBS</option>
                                    <option value="@((int)ProcurementMethod.LCS)">LCS</option>
                                    <option value="@((int)ProcurementMethod.FBS)">FBS</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–¢–∏–ø –∑–∞–∫—É–ø–∫–∏</label>
                                <select asp-for="Type" class="form-select">
                                    <option value="@((int)ProcurementType.Goods)">–¢–æ–≤–∞—Ä—ã</option>
                                    <option value="@((int)ProcurementType.Works)">–†–∞–±–æ—Ç—ã</option>
                                    <option value="@((int)ProcurementType.ConsultingServices)">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</option>
                                    <option value="@((int)ProcurementType.NonConsultingServices)">–ù–µ–∫–æ–Ω. —É—Å–ª—É–≥–∏</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–û—Ü–µ–Ω–æ—á–Ω–∞—è —Å—É–º–º–∞ (USD)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" asp-for="EstimatedAmount" class="form-control" step="0.01" min="0" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select asp-for="Status" class="form-select">
                                    <option value="@((int)ProcurementStatus.Planned)">üîµ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                                    <option value="@((int)ProcurementStatus.InProgress)">‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                                    <option value="@((int)ProcurementStatus.Evaluation)">üìã –û—Ü–µ–Ω–∫–∞</option>
                                    <option value="@((int)ProcurementStatus.Awarded)">üèÜ –ü—Ä–∏—Å—É–∂–¥–µ–Ω–æ</option>
                                    <option value="@((int)ProcurementStatus.Completed)">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                    <option value="@((int)ProcurementStatus.Cancelled)">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>–°—Ä–æ–∫–∏</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-muted mb-3">–ü–ª–∞–Ω–æ–≤—ã–µ –¥–∞—Ç—ã</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">–î–∞—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</label>
                                <input type="date" asp-for="AdvertisementDate" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–î–∞—Ç–∞ —Ç–µ–Ω–¥–µ—Ä–∞</label>
                                <input type="date" asp-for="PlannedBidOpeningDate" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è</label>
                                <input type="date" asp-for="PlannedContractSigningDate" class="form-control" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</label>
                                <input type="date" asp-for="PlannedCompletionDate" class="form-control" />
                            </div>
                        </div>

                        <h6 class="text-muted mb-3 mt-4">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞—Ç—ã</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">–î–∞—Ç–∞ —Ç–µ–Ω–¥–µ—Ä–∞</label>
                                <input type="date" asp-for="ActualBidOpeningDate" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è</label>
                                <input type="date" asp-for="ActualContractSigningDate" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</label>
                                <input type="date" asp-for="ActualCompletionDate" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>–°–≤—è–∑—å —Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">–ö–æ–Ω—Ç—Ä–∞–∫—Ç (–ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è)</label>
                                <select asp-for="ContractId" asp-items="ViewBag.Contracts" class="form-select">
                                    <option value="">‚Äî –ù–µ —Å–≤—è–∑–∞–Ω ‚Äî</option>
                                </select>
                                <small class="text-muted">–°–≤—è–∑–∞—Ç—å —ç—Ç—É –ø–æ–∑–∏—Ü–∏—é —Å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–º</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        <textarea asp-for="Comments" class="form-control" rows="3"></textarea>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <a asp-action="Index" asp-route-projectId="@Model.ProjectId" class="btn btn-outline-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('projectSelect').addEventListener('change', async function() {
        const projectId = this.value;
        const componentSelect = document.getElementById('componentSelect');
        const subComponentSelect = document.getElementById('subComponentSelect');
        
        componentSelect.innerHTML = '<option value="">‚Äî –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî</option>';
        subComponentSelect.innerHTML = '<option value="">‚Äî –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî</option>';
        
        if (projectId) {
            const response = await fetch(`/Procurement/GetComponentsByProject?projectId=${projectId}`);
            const components = await response.json();
            components.forEach(c => {
                componentSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
    });

    document.getElementById('componentSelect').addEventListener('change', async function() {
        const componentId = this.value;
        const subComponentSelect = document.getElementById('subComponentSelect');
        
        subComponentSelect.innerHTML = '<option value="">‚Äî –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ ‚Äî</option>';
        
        if (componentId) {
            const response = await fetch(`/Procurement/GetSubComponentsByComponent?componentId=${componentId}`);
            const subComponents = await response.json();
            subComponents.forEach(sc => {
                subComponentSelect.innerHTML += `<option value="${sc.id}">${sc.name}</option>`;
            });
        }
    });
</script>
}
