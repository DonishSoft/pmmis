@model PMMIS.Domain.Entities.ProcurementPlan
@using PMMIS.Domain.Entities
@{
    ViewData["Title"] = Model.ReferenceNo;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var permissionService = ViewContext.HttpContext.RequestServices.GetRequiredService<PMMIS.Web.Services.IPermissionService>();
    var canEdit = await permissionService.HasPermissionAsync(User, "Procurement", "edit");

    string GetMethodName(ProcurementMethod method) => method switch
    {
        ProcurementMethod.NCB => "NCB ‚Äî National Competitive Bidding",
        ProcurementMethod.ICB => "ICB ‚Äî International Competitive Bidding",
        ProcurementMethod.Shopping => "Shopping",
        ProcurementMethod.DirectContracting => "Direct Contracting",
        ProcurementMethod.CQS => "CQS ‚Äî Consultant Qualification Selection",
        ProcurementMethod.QCBS => "QCBS ‚Äî Quality and Cost Based Selection",
        ProcurementMethod.LCS => "LCS ‚Äî Least Cost Selection",
        ProcurementMethod.FBS => "FBS ‚Äî Fixed Budget Selection",
        _ => method.ToString()
    };

    string GetTypeName(ProcurementType type) => type switch
    {
        ProcurementType.Goods => "–¢–æ–≤–∞—Ä—ã",
        ProcurementType.Works => "–†–∞–±–æ—Ç—ã",
        ProcurementType.ConsultingServices => "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏",
        ProcurementType.NonConsultingServices => "–ù–µ–∫–æ–Ω. —É—Å–ª—É–≥–∏",
        _ => type.ToString()
    };

    string GetStatusName(ProcurementStatus status) => status switch
    {
        ProcurementStatus.Planned => "üîµ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ",
        ProcurementStatus.InProgress => "‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ",
        ProcurementStatus.Evaluation => "üìã –û—Ü–µ–Ω–∫–∞",
        ProcurementStatus.Awarded => "üèÜ –ü—Ä–∏—Å—É–∂–¥–µ–Ω–æ",
        ProcurementStatus.Completed => "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ",
        ProcurementStatus.Cancelled => "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ",
        _ => status.ToString()
    };

    string GetStatusBadgeClass(ProcurementStatus status) => status switch
    {
        ProcurementStatus.Planned => "bg-secondary",
        ProcurementStatus.InProgress => "bg-primary",
        ProcurementStatus.Evaluation => "bg-warning text-dark",
        ProcurementStatus.Awarded => "bg-info",
        ProcurementStatus.Completed => "bg-success",
        ProcurementStatus.Cancelled => "bg-danger",
        _ => "bg-secondary"
    };

    string GetTypeBadgeClass(ProcurementType type) => type switch
    {
        ProcurementType.Goods => "bg-primary",
        ProcurementType.Works => "bg-warning text-dark",
        ProcurementType.ConsultingServices => "bg-success",
        _ => "bg-secondary"
    };
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ü–ª–∞–Ω –∑–∞–∫—É–ø–æ–∫</a></li>
            <li class="breadcrumb-item active">@Model.ReferenceNo</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">@Model.ReferenceNo</h2>
            <p class="text-muted mb-0">@Model.Description</p>
        </div>
        <div class="d-flex gap-2">
            @if (canEdit)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
            }
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <!-- Status Cards Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–û—Ü–µ–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <div class="fs-3 fw-bold text-primary">$@Model.EstimatedAmount.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–°—Ç–∞—Ç—É—Å</div>
                    <div class="mt-1">
                        <span class="badge @GetStatusBadgeClass(Model.Status) fs-6">@GetStatusName(Model.Status)</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–ú–µ—Ç–æ–¥ –∑–∞–∫—É–ø–∫–∏</div>
                    <div class="mt-1">
                        <span class="badge bg-info fs-6">@Model.Method</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–¢–∏–ø</div>
                    <div class="mt-1">
                        <span class="badge @GetTypeBadgeClass(Model.Type) fs-6">@GetTypeName(Model.Type)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Plan Info -->
        <div class="col-lg-7">
            <!-- Plan Details Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clipboard-check me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞–Ω–µ –∑–∞–∫—É–ø–∫–∏
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="text-muted" style="width: 220px">–†–µ—Ñ–µ—Ä–µ–Ω—Å –Ω–æ–º–µ—Ä:</td>
                                <td class="fw-semibold"><code>@Model.ReferenceNo</code></td>
                            </tr>
                            <tr>
                                <td class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ:</td>
                                <td>@Model.Description</td>
                            </tr>
                            @if (!string.IsNullOrEmpty(Model.DescriptionTj))
                            {
                                <tr>
                                    <td class="text-muted">–û–ø–∏—Å–∞–Ω–∏–µ (—Ç–∞–¥–∂.):</td>
                                    <td>@Model.DescriptionTj</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(Model.DescriptionEn))
                            {
                                <tr>
                                    <td class="text-muted">Description (EN):</td>
                                    <td>@Model.DescriptionEn</td>
                                </tr>
                            }
                            <tr>
                                <td class="text-muted">–ú–µ—Ç–æ–¥ –∑–∞–∫—É–ø–∫–∏:</td>
                                <td>
                                    <span class="badge bg-info">@Model.Method</span>
                                    <span class="text-muted ms-1 small">@GetMethodName(Model.Method)</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">–¢–∏–ø:</td>
                                <td>
                                    <span class="badge @GetTypeBadgeClass(Model.Type)">@GetTypeName(Model.Type)</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">–û—Ü–µ–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</td>
                                <td class="fw-bold text-primary">$@Model.EstimatedAmount.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td class="text-muted">–°—Ç–∞—Ç—É—Å:</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(Model.Status)">@GetStatusName(Model.Status)</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">–ü—Ä–æ–µ–∫—Ç:</td>
                                <td>
                                    <span class="badge bg-secondary">@Model.Project.Code</span>
                                    @Model.Project.NameRu
                                </td>
                            </tr>
                            @if (Model.Component != null)
                            {
                                <tr>
                                    <td class="text-muted">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:</td>
                                    <td>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç @Model.Component.Number ‚Äî @Model.Component.NameRu</td>
                                </tr>
                            }
                            @if (Model.SubComponent != null)
                            {
                                <tr>
                                    <td class="text-muted">–°—É–±–∫–æ–º–ø–æ–Ω–µ–Ω—Ç:</td>
                                    <td>@Model.SubComponent.Code ‚Äî @Model.SubComponent.NameRu</td>
                                </tr>
                            }
                            @if (!string.IsNullOrEmpty(Model.Comments))
                            {
                                <tr>
                                    <td class="text-muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</td>
                                    <td>@Model.Comments</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dates Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar3 me-2"></i>–î–∞—Ç—ã
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th></th>
                                <th class="text-center">–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th>
                                <th class="text-center">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-muted">–û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞</td>
                                <td class="text-center">@(Model.PlannedBidOpeningDate?.ToString("dd.MM.yyyy") ?? "‚Äî")</td>
                                <td class="text-center">
                                    @if (Model.ActualBidOpeningDate.HasValue)
                                    {
                                        <span class="text-success fw-semibold">@Model.ActualBidOpeningDate?.ToString("dd.MM.yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">–ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</td>
                                <td class="text-center">@(Model.PlannedContractSigningDate?.ToString("dd.MM.yyyy") ?? "‚Äî")</td>
                                <td class="text-center">
                                    @if (Model.ActualContractSigningDate.HasValue)
                                    {
                                        <span class="text-success fw-semibold">@Model.ActualContractSigningDate?.ToString("dd.MM.yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</td>
                                <td class="text-center">@(Model.PlannedCompletionDate?.ToString("dd.MM.yyyy") ?? "‚Äî")</td>
                                <td class="text-center">
                                    @if (Model.ActualCompletionDate.HasValue)
                                    {
                                        <span class="text-success fw-semibold">@Model.ActualCompletionDate?.ToString("dd.MM.yyyy")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">‚Äî</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Contractor & Contract Info -->
        <div class="col-lg-5">
            <!-- Contract Card -->
            @if (Model.Contract != null)
            {
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>–ö–æ–Ω—Ç—Ä–∞–∫—Ç
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <td class="text-muted" style="width: 140px">–ù–æ–º–µ—Ä:</td>
                                    <td>
                                        <a asp-controller="Contracts" asp-action="Details" asp-route-id="@Model.Contract.Id" class="fw-bold text-primary text-decoration-none">
                                            @Model.Contract.ContractNumber
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">–û–±—ä—ë–º —Ä–∞–±–æ—Ç:</td>
                                    <td>@Model.Contract.ScopeOfWork</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">–°—É–º–º–∞:</td>
                                    <td class="fw-bold text-primary">$@Model.Contract.FinalAmount.ToString("N0")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">–ü–æ–¥–ø–∏—Å–∞–Ω:</td>
                                    <td>@Model.Contract.SigningDate.ToString("dd.MM.yyyy")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">–°—Ä–æ–∫:</td>
                                    <td>@Model.Contract.ContractEndDate.ToString("dd.MM.yyyy")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å:</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress flex-grow-1" style="height: 8px;">
                                                <div class="progress-bar bg-success" style="width: @Model.Contract.WorkCompletedPercent%"></div>
                                            </div>
                                            <span class="fw-semibold small">@Model.Contract.WorkCompletedPercent%</span>
                                        </div>
                                    </td>
                                </tr>
                                @if (Model.Contract.Payments.Any())
                                {
                                    var totalPaid = Model.Contract.Payments.Where(p => p.Status == PaymentStatus.Paid).Sum(p => p.Amount);
                                    <tr>
                                        <td class="text-muted">–û–ø–ª–∞—á–µ–Ω–æ:</td>
                                        <td>
                                            <span class="fw-semibold text-success">$@totalPaid.ToString("N0")</span>
                                            <span class="text-muted small">–∏–∑ $@Model.Contract.FinalAmount.ToString("N0")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        <div class="mt-3">
                            <a asp-controller="Contracts" asp-action="Details" asp-route-id="@Model.Contract.Id" class="btn btn-sm btn-outline-primary w-100">
                                <i class="bi bi-box-arrow-up-right me-1"></i> –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Contractor Card -->
                @if (Model.Contract.Contractor != null)
                {
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-building me-2"></i>–ü–æ–¥—Ä—è–¥—á–∏–∫
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="text-muted" style="width: 140px">–ù–∞–∑–≤–∞–Ω–∏–µ:</td>
                                        <td class="fw-semibold">
                                            <a asp-controller="Contractors" asp-action="Details" asp-route-id="@Model.Contract.Contractor.Id" class="text-dark text-decoration-none">
                                                @Model.Contract.Contractor.Name
                                            </a>
                                        </td>
                                    </tr>
                                    @if (!string.IsNullOrEmpty(Model.Contract.Contractor.Country))
                                    {
                                        <tr>
                                            <td class="text-muted">–°—Ç—Ä–∞–Ω–∞:</td>
                                            <td><i class="bi bi-geo-alt me-1"></i>@Model.Contract.Contractor.Country</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.Contract.Contractor.ContactPerson))
                                    {
                                        <tr>
                                            <td class="text-muted">–ö–æ–Ω—Ç–∞–∫—Ç:</td>
                                            <td>@Model.Contract.Contractor.ContactPerson</td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.Contract.Contractor.Email))
                                    {
                                        <tr>
                                            <td class="text-muted">E-mail:</td>
                                            <td><a href="mailto:@Model.Contract.Contractor.Email">@Model.Contract.Contractor.Email</a></td>
                                        </tr>
                                    }
                                    @if (!string.IsNullOrEmpty(Model.Contract.Contractor.Phone))
                                    {
                                        <tr>
                                            <td class="text-muted">–¢–µ–ª–µ—Ñ–æ–Ω:</td>
                                            <td>@Model.Contract.Contractor.Phone</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                            <div class="mt-3">
                                <a asp-controller="Contractors" asp-action="Details" asp-route-id="@Model.Contract.Contractor.Id" class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="bi bi-box-arrow-up-right me-1"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –ø–æ–¥—Ä—è–¥—á–∏–∫–µ
                                </a>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-file-earmark-x fs-1 text-muted d-block mb-3"></i>
                        <p class="text-muted mb-0">–ö–æ–Ω—Ç—Ä–∞–∫—Ç –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω</p>
                        <small class="text-muted">–ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–∏—Å—É–∂–¥–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∏</small>
                    </div>
                </div>
            }

            <!-- Meta Info -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <small class="text-muted d-block">
                        <i class="bi bi-clock me-1"></i> –°–æ–∑–¥–∞–Ω–æ: @Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                    </small>
                    @if (Model.UpdatedAt.HasValue)
                    {
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-pencil me-1"></i> –û–±–Ω–æ–≤–ª–µ–Ω–æ: @Model.UpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")
                        </small>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
