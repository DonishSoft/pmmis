@model PMMIS.Web.ViewModels.Payments.PaymentFormViewModel
@using PMMIS.Domain.Entities
@{
    ViewData["Title"] = "–ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ü–ª–∞—Ç–µ–∂–∏</a></li>
            <li class="breadcrumb-item active">–ù–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <form asp-action="Create" method="post">
                <input type="hidden" asp-for="Payment.Id" />
                
                <!-- Validation Summary -->
                <div asp-validation-summary="All" class="alert alert-danger validation-summary-errors mb-3"></div>
                <style>
                    .validation-summary-valid { display: none; }
                </style>
                
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="form-label">–ö–æ–Ω—Ç—Ä–∞–∫—Ç <span class="text-danger">*</span></label>
                                <select asp-for="Payment.ContractId" asp-items="Model.Contracts" class="form-select" id="paymentContractId" required>
                                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç ‚Äî</option>
                                </select>
                                <span asp-validation-for="Payment.ContractId" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- AVR (Work Progress) Selection -->
                        <div class="row g-3 mt-2" id="avrSelectionGroup" style="display: none;">
                            <div class="col-md-12">
                                <label class="form-label"><i class="bi bi-clipboard-check me-1"></i>–ê–í–† (–ê–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç)</label>
                                <select class="form-select" id="avrSelect" name="Payment.WorkProgressId">
                                    <option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ê–í–† ‚Äî</option>
                                </select>
                                <small class="text-muted" id="avrInfo"></small>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label class="form-label">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞ <span class="text-danger">*</span></label>
                                <input type="date" asp-for="Payment.PaymentDate" class="form-control" id="paymentDate" required />
                                <span asp-validation-for="Payment.PaymentDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ <span class="text-danger">*</span></label>
                                <select asp-for="Payment.Type" class="form-select">
                                    <option value="@((int)PaymentType.Advance)">üíµ –ê–≤–∞–Ω—Å</option>
                                    <option value="@((int)PaymentType.Interim)">üìä –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π</option>
                                    <option value="@((int)PaymentType.Final)">‚úÖ –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π</option>
                                    <option value="@((int)PaymentType.Retention)">üîí –£–¥–µ—Ä–∂–∞–Ω–∏–µ</option>
                                </select>
                                <span asp-validation-for="Payment.Type" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select asp-for="Payment.Status" class="form-select">
                                    <option value="@((int)PaymentStatus.Pending)">‚è≥ –û–∂–∏–¥–∞–µ—Ç</option>
                                    <option value="@((int)PaymentStatus.Approved)">‚úì –û–¥–æ–±—Ä–µ–Ω</option>
                                    <option value="@((int)PaymentStatus.Paid)">‚úÖ –û–ø–ª–∞—á–µ–Ω</option>
                                    <option value="@((int)PaymentStatus.Rejected)">‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω</option>
                                </select>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <!-- TJS amount (primary for TJS contracts) -->
                            <div class="col-md-4" id="tjsPaymentGroup" style="display: none;">
                                <label class="form-label">–°—É–º–º–∞ (TJS) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">SM</span>
                                    <input type="number" asp-for="Payment.AmountTjs" class="form-control" id="paymentAmountTjs" step="0.01" min="0" />
                                </div>
                            </div>
                            <!-- Exchange rate (for TJS contracts) -->
                            <div class="col-md-4" id="tjsPaymentRateGroup" style="display: none;">
                                <label class="form-label">–ö—É—Ä—Å USD/TJS</label>
                                <div class="input-group">
                                    <span class="input-group-text">üìä</span>
                                    <input type="number" asp-for="Payment.ExchangeRate" class="form-control" id="paymentExchangeRate" step="0.0001" readonly />
                                </div>
                                <small class="text-muted" id="paymentRateInfo">–ù–∞ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞</small>
                            </div>
                            <!-- USD amount -->
                            <div class="col-md-4" id="usdAmountGroup">
                                <label class="form-label" id="amountLabel">–°—É–º–º–∞ (USD) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text" id="amountPrefix">$</span>
                                    <input type="number" asp-for="Payment.Amount" class="form-control" id="paymentAmountUsd" step="0.01" min="0" required />
                                </div>
                                <span asp-validation-for="Payment.Amount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞</label>
                                <input type="text" asp-for="Payment.InvoiceNumber" class="form-control" placeholder="INV-2024-001" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea asp-for="Payment.Description" class="form-control" rows="2" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> –°–æ–∑–¥–∞—Ç—å
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
    // Contract currency map: contractId -> { currency: 0=USD/1=TJS }
    const contractCurrencies = {};
    @foreach (var c in ViewBag.ContractCurrencies as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>())
    {
        @:contractCurrencies[@c.Id] = { currency: @c.Currency, rate: @(c.Rate != null ? ((decimal)c.Rate).ToString(System.Globalization.CultureInfo.InvariantCulture) : "null") };
    }

    const contractSelect = document.getElementById('paymentContractId');
    const paymentDate = document.getElementById('paymentDate');
    const paymentAmountUsd = document.getElementById('paymentAmountUsd');
    const paymentAmountTjs = document.getElementById('paymentAmountTjs');
    const paymentExchangeRate = document.getElementById('paymentExchangeRate');
    const tjsPaymentGroup = document.getElementById('tjsPaymentGroup');
    const tjsPaymentRateGroup = document.getElementById('tjsPaymentRateGroup');
    const amountLabel = document.getElementById('amountLabel');
    const paymentRateInfo = document.getElementById('paymentRateInfo');

    function onContractChange() {
        const contractId = contractSelect.value;
        const info = contractCurrencies[contractId];
        const isTjs = info && info.currency === 1;

        tjsPaymentGroup.style.display = isTjs ? '' : 'none';
        tjsPaymentRateGroup.style.display = isTjs ? '' : 'none';

        if (isTjs) {
            amountLabel.innerHTML = '–°—É–º–º–∞ (USD) <small class="text-muted">–∞–≤—Ç–æ</small>';
            paymentAmountUsd.readOnly = true;
            fetchPaymentRate();
        } else {
            amountLabel.innerHTML = '–°—É–º–º–∞ (USD) <span class="text-danger">*</span>';
            paymentAmountUsd.readOnly = false;
            paymentAmountTjs.value = '';
            paymentExchangeRate.value = '';
        }
    }

    async function fetchPaymentRate() {
        const dateVal = paymentDate?.value;
        if (!dateVal) {
            paymentRateInfo.textContent = '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞';
            return;
        }
        paymentRateInfo.innerHTML = '<i class="bi bi-hourglass-split"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
        try {
            const resp = await fetch(`/Currency/GetUsdRate?date=${dateVal}`);
            const data = await resp.json();
            if (data.rate) {
                paymentExchangeRate.value = data.rate;
                paymentRateInfo.textContent = `–ö—É—Ä—Å –ù–ë–¢ –Ω–∞ ${dateVal}`;
                calculateUsdFromTjs();
            } else {
                paymentRateInfo.textContent = '–ö—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
            }
        } catch (e) {
            paymentRateInfo.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
        }
    }

    function calculateUsdFromTjs() {
        const tjs = parseFloat(paymentAmountTjs.value) || 0;
        const rate = parseFloat(paymentExchangeRate.value) || 0;
        paymentAmountUsd.value = rate > 0 ? (tjs / rate).toFixed(2) : '';
    }

    contractSelect.addEventListener('change', () => {
        onContractChange();
        loadApprovedAvrs();
    });
    paymentDate.addEventListener('change', () => {
        const info = contractCurrencies[contractSelect.value];
        if (info && info.currency === 1) fetchPaymentRate();
    });
    if (paymentAmountTjs) paymentAmountTjs.addEventListener('input', calculateUsdFromTjs);

    // === AVR Selection Logic ===
    const avrSelectionGroup = document.getElementById('avrSelectionGroup');
    const avrSelect = document.getElementById('avrSelect');
    const avrInfo = document.getElementById('avrInfo');

    async function loadApprovedAvrs() {
        const contractId = contractSelect.value;
        if (!contractId) {
            avrSelectionGroup.style.display = 'none';
            return;
        }

        try {
            const resp = await fetch(`/Payments/GetApprovedAvrs?contractId=${contractId}`);
            const avrs = await resp.json();

            // Clear existing options
            avrSelect.innerHTML = '<option value="">‚Äî –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ê–í–† ‚Äî</option>';

            if (avrs.length === 0) {
                avrSelectionGroup.style.display = 'none';
                avrInfo.textContent = '';
                return;
            }

            // Populate options
            avrs.forEach(avr => {
                const opt = document.createElement('option');
                opt.value = avr.id;
                opt.textContent = avr.text;
                avrSelect.appendChild(opt);
            });

            avrSelectionGroup.style.display = '';

            // Auto-select if only 1 AVR
            if (avrs.length === 1) {
                avrSelect.value = avrs[0].id;
                avrInfo.innerHTML = '<span class="text-success"><i class="bi bi-check-circle me-1"></i>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –ê–í–†</span>';
            } else {
                avrInfo.innerHTML = `<span class="text-info"><i class="bi bi-info-circle me-1"></i>–ù–∞–π–¥–µ–Ω–æ ${avrs.length} —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –ê–í–† ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π</span>`;
            }
        } catch (e) {
            avrSelectionGroup.style.display = 'none';
            console.error('Error loading AVRs:', e);
        }
    }

    // Init on load
    if (contractSelect.value) {
        onContractChange();
        loadApprovedAvrs();
    }
    </script>
}
