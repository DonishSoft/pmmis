@model PMMIS.Web.ViewModels.Reports.EmployeeKpiReportViewModel

<!-- Summary Statistics Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small text-uppercase fw-semibold">Сотрудников</div>
                        <div class="fs-2 fw-bold text-primary">@Model.TotalEmployees</div>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-3 p-2">
                        <i class="bi bi-people text-primary fs-4"></i>
                    </div>
                </div>
                <div class="text-muted small mt-2">@Model.ActiveEmployees с задачами</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small text-uppercase fw-semibold">Всего задач</div>
                        <div class="fs-2 fw-bold text-dark">@Model.TotalTasks</div>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-3 p-2">
                        <i class="bi bi-list-task text-info fs-4"></i>
                    </div>
                </div>
                <div class="text-muted small mt-2">@Model.TotalCompletedTasks выполнено</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small text-uppercase fw-semibold">Среднее выполнение</div>
                        <div class="fs-2 fw-bold text-success">@Model.AverageCompletionRate%</div>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-3 p-2">
                        <i class="bi bi-check2-all text-success fs-4"></i>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-success" style="width: @Model.AverageCompletionRate.ToString("F0")%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small text-uppercase fw-semibold">Просрочено</div>
                        <div class="fs-2 fw-bold text-danger">@Model.TotalOverdueTasks</div>
                    </div>
                    <div class="bg-danger bg-opacity-10 rounded-3 p-2">
                        <i class="bi bi-exclamation-triangle text-danger fs-4"></i>
                    </div>
                </div>
                <div class="text-muted small mt-2">требуют внимания</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row g-3 mb-4">
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Задачи по сотрудникам</h6>
            </div>
            <div class="card-body">
                <canvas id="employeeBarChart" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Статус задач</h6>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="statusDoughnut" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Employees Table -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0">
        <h6 class="mb-0"><i class="bi bi-table me-2"></i>Детализация по сотрудникам</h6>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Сотрудник</th>
                        <th>Должность</th>
                        <th class="text-center">Всего задач</th>
                        <th class="text-center">Выполнено</th>
                        <th class="text-center">В работе</th>
                        <th class="text-center">Просрочено</th>
                        <th class="text-center">АВР</th>
                        <th class="text-center" style="width: 160px;">Выполнение</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var emp in Model.Employees)
                    {
                        var barColor = emp.CompletionPercent >= 80 ? "bg-success" 
                            : emp.CompletionPercent >= 50 ? "bg-info" 
                            : emp.CompletionPercent > 0 ? "bg-warning" 
                            : "bg-secondary";
                        <tr>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 36px; height: 36px;">
                                        <span class="text-primary fw-bold small">
                                            @(emp.FullName.Length >= 2 ? emp.FullName[..1] : "?")
                                        </span>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">@emp.FullName</div>
                                        <small class="text-muted">@emp.Email</small>
                                    </div>
                                </div>
                            </td>
                            <td class="text-muted">@(emp.Position ?? "—")</td>
                            <td class="text-center fw-semibold">@emp.TotalTasks</td>
                            <td class="text-center">
                                <span class="badge bg-success-subtle text-success-emphasis">@emp.CompletedTasks</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-info-subtle text-info-emphasis">@emp.InProgressTasks</span>
                            </td>
                            <td class="text-center">
                                @if (emp.OverdueTasks > 0)
                                {
                                    <span class="badge bg-danger">@emp.OverdueTasks</span>
                                }
                                else
                                {
                                    <span class="text-muted">0</span>
                                }
                            </td>
                            <td class="text-center">
                                <span class="badge bg-secondary-subtle text-secondary-emphasis">@emp.AvrCount</span>
                            </td>
                            <td class="text-center">
                                @if (emp.TotalTasks > 0)
                                {
                                    <div class="d-flex align-items-center gap-1">
                                        <div class="progress flex-grow-1" style="height: 6px; min-width: 60px;">
                                            <div class="progress-bar @barColor"
                                                 style="width: @emp.CompletionPercent.ToString("F0")%"></div>
                                        </div>
                                        <small class="fw-semibold" style="min-width: 40px;">@emp.CompletionPercent.ToString("F0")%</small>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
    // Filter employees with tasks for charts
    const activeEmployees = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.Employees.Where(e => e.TotalTasks > 0).Select(e => new { 
            e.FullName, e.CompletedTasks, e.InProgressTasks, e.OverdueTasks, 
            Other = e.TotalTasks - e.CompletedTasks - e.InProgressTasks - e.OverdueTasks 
        })));

    // Horizontal bar chart
    new Chart(document.getElementById('employeeBarChart'), {
        type: 'bar',
        data: {
            labels: activeEmployees.map(e => e.FullName),
            datasets: [
                {
                    label: 'Выполнено',
                    data: activeEmployees.map(e => e.CompletedTasks),
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderRadius: 4
                },
                {
                    label: 'В работе',
                    data: activeEmployees.map(e => e.InProgressTasks),
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderRadius: 4
                },
                {
                    label: 'Просрочено',
                    data: activeEmployees.map(e => e.OverdueTasks),
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderRadius: 4
                },
                {
                    label: 'Прочие',
                    data: activeEmployees.map(e => e.Other < 0 ? 0 : e.Other),
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderRadius: 4
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
                x: { stacked: true, beginAtZero: true },
                y: { stacked: true }
            }
        }
    });

    // Doughnut: overall status distribution
    const totalCompleted = @Model.TotalCompletedTasks;
    const totalOverdue = @Model.TotalOverdueTasks;
    const totalInProgress = @Model.Employees.Sum(e => e.InProgressTasks);
    const totalOther = @Model.TotalTasks - totalCompleted - totalInProgress - totalOverdue;

    new Chart(document.getElementById('statusDoughnut'), {
        type: 'doughnut',
        data: {
            labels: ['Выполнено', 'В работе', 'Просрочено', 'Прочие'],
            datasets: [{
                data: [totalCompleted, totalInProgress, totalOverdue, Math.max(0, totalOther)],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(239, 68, 68, 0.8)',
                    'rgba(156, 163, 175, 0.5)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 12, padding: 12, font: { size: 11 } }
                }
            }
        }
    });
</script>
