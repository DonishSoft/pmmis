@{
    ViewData["Title"] = "KPI сотрудников";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1"><i class="bi bi-person-lines-fill me-2"></i>KPI сотрудников</h4>
            <p class="text-muted mb-0">Анализ эффективности сотрудников по задачам и активности</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> Печать
            </button>
        </div>
    </div>

    <!-- Skeleton placeholder -->
    <div id="report-skeleton">
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="skeleton skeleton-card"></div></div>
            <div class="col-md-3"><div class="skeleton skeleton-card"></div></div>
            <div class="col-md-3"><div class="skeleton skeleton-card"></div></div>
            <div class="col-md-3"><div class="skeleton skeleton-card"></div></div>
        </div>
        <div class="row g-3 mb-4">
            <div class="col-lg-7"><div class="skeleton skeleton-chart"></div></div>
            <div class="col-lg-5"><div class="skeleton skeleton-chart"></div></div>
        </div>
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="skeleton skeleton-text lg mb-3"></div>
                @for (int i = 0; i < 6; i++)
                {
                    <div class="skeleton skeleton-table-row"></div>
                }
            </div>
        </div>
    </div>

    <div id="report-data" style="display:none;"></div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('@Url.Action("EmployeeKpiData")')
                .then(r => r.text())
                .then(html => {
                    document.getElementById('report-data').innerHTML = html;
                    document.getElementById('report-skeleton').style.display = 'none';
                    document.getElementById('report-data').style.display = 'block';
                    document.getElementById('report-data').querySelectorAll('script').forEach(oldScript => {
                        const newScript = document.createElement('script');
                        if (oldScript.src) { newScript.src = oldScript.src; } 
                        else { newScript.textContent = oldScript.textContent; }
                        document.body.appendChild(newScript);
                    });
                })
                .catch(err => {
                    document.getElementById('report-skeleton').innerHTML = 
                        '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>Ошибка загрузки данных.</div>';
                });
        });
    </script>
}
