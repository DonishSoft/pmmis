@model PMMIS.Domain.Entities.Contract
@using PMMIS.Domain.Entities
@{
    ViewData["Title"] = Model.ContractNumber;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var permissionService = ViewContext.HttpContext.RequestServices.GetRequiredService<PMMIS.Web.Services.IPermissionService>();
    var canEdit = await permissionService.HasPermissionAsync(User, "Contracts", "edit");
    var canDelete = await permissionService.HasPermissionAsync(User, "Contracts", "delete");
    var canAmend = await permissionService.HasPermissionAsync(User, "ContractAmendments", "create");
    var canDeleteAmendment = await permissionService.HasPermissionAsync(User, "ContractAmendments", "delete");
}

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã</a></li>
            <li class="breadcrumb-item active">@Model.ContractNumber</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="mb-1">@Model.ContractNumber</h2>
            <p class="text-muted mb-0">@Model.Contractor.Name</p>
        </div>
        <div class="d-flex gap-2">
            @if (canAmend)
            {
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#amendmentModal">
                    <i class="bi bi-pencil-square me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ø—Ä–∞–≤–∫—É
                </button>
            }
            @if (canEdit)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
            }
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <!-- Status indicators -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–ò—Ç–æ–≥–æ</div>
                    <div class="fs-3 fw-bold text-primary">$@Model.FinalAmount.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–û–ø–ª–∞—á–µ–Ω–æ</div>
                    <div class="fs-3 fw-bold text-success">@Model.PaidPercent.ToString("N1")%</div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: @Model.PaidPercent%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                    <div class="fs-3 fw-bold text-info">@Model.WorkCompletedPercent.ToString("N1")%</div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: @Model.WorkCompletedPercent%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="text-muted small">–°—Ä–æ–∫</div>
                    @if (Model.RemainingDays < 0)
                    {
                        <div class="fs-3 fw-bold text-danger">@Math.Abs(Model.RemainingDays) –¥–Ω.</div>
                        <span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
                    }
                    else if (Model.RemainingDays < 30)
                    {
                        <div class="fs-3 fw-bold text-warning">@Model.RemainingDays –¥–Ω.</div>
                        <span class="badge bg-warning text-dark">–°–∫–æ—Ä–æ</span>
                    }
                    else
                    {
                        <div class="fs-3 fw-bold text-success">@Model.RemainingDays –¥–Ω.</div>
                        <span class="badge bg-success">–í –Ω–æ—Ä–º–µ</span>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Contract Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 200px" class="text-muted">–¢–∏–ø:</th>
                            <td>
                                @switch (Model.Type)
                                {
                                    case ContractType.Works:
                                        <span class="badge bg-warning text-dark">üèóÔ∏è –°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</span>
                                        break;
                                    case ContractType.Consulting:
                                        <span class="badge bg-info">üíº –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</span>
                                        break;
                                    case ContractType.Goods:
                                        <span class="badge bg-primary">üì¶ –¢–æ–≤–∞—Ä—ã</span>
                                        break;
                                }
                            </td>
                        </tr>
                        <tr>
                            <th class="text-muted">–ü—Ä–æ–µ–∫—Ç:</th>
                            <td><span class="badge bg-secondary">@Model.Project.Code</span> @Model.Project.NameRu</td>
                        </tr>
                        @if (Model.SubComponent != null)
                        {
                            <tr>
                                <th class="text-muted">–ü–æ–¥–∫–æ–º–ø–æ–Ω–µ–Ω—Ç:</th>
                                <td>@Model.SubComponent.Code: @Model.SubComponent.NameRu</td>
                            </tr>
                        }
                        <tr>
                            <th class="text-muted">–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è:</th>
                            <td>@Model.SigningDate.ToString("dd MMMM yyyy")</td>
                        </tr>
                        <tr>
                            <th class="text-muted">–°—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</th>
                            <td>
                                @Model.ContractEndDate.ToString("dd MMMM yyyy")
                                @if (Model.ExtendedToDate.HasValue)
                                {
                                    <span class="text-success ms-2">
                                        <i class="bi bi-arrow-right"></i> –ø—Ä–æ–¥–ª—ë–Ω –¥–æ @Model.ExtendedToDate.Value.ToString("dd.MM.yyyy")
                                    </span>
                                }
                            </td>
                        </tr>
                    </table>

                    <hr />

                    <h6>–û–±—ä—ë–º —Ä–∞–±–æ—Ç</h6>
                    <p class="mb-0">@Model.ScopeOfWork</p>
                    @if (!string.IsNullOrEmpty(Model.ScopeOfWorkEn))
                    {
                        <p class="text-muted small mt-2"><em>EN: @Model.ScopeOfWorkEn</em></p>
                    }

                    @if (Model.Curator != null || Model.ProjectManager != null)
                    {
                        <hr />
                        <h6>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–∏—Ü–∞</h6>
                        <div class="row g-3">
                            @if (Model.Curator != null)
                            {
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <small class="text-muted">–ö—É—Ä–∞—Ç–æ—Ä</small><br />
                                            <strong>@Model.Curator.FullName</strong>
                                            <div class="small text-muted">@Model.Curator.Email</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (Model.ProjectManager != null)
                            {
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <small class="text-muted">–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞</small><br />
                                            <strong>@Model.ProjectManager.FullName</strong>
                                            <div class="small text-muted">@Model.ProjectManager.Email</div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (Model.Milestones?.Any() == true)
            {
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-flag me-2"></i>–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —ç—Ç–∞–ø—ã</h5>
                        <span class="badge bg-secondary">@Model.Milestones.Count —ç—Ç–∞–ø–æ–≤</span>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—Ä–æ–∫</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ var msOrder = 1; }
                                @foreach (var ms in Model.Milestones.OrderBy(m => m.SortOrder))
                                {
                                    var isCompleted = ms.Status == MilestoneStatus.Completed;
                                    var isOverdue = ms.DueDate < DateTime.Today && !isCompleted;
                                    <tr class="@(isOverdue ? "table-danger" : isCompleted ? "table-success" : "")">
                                        <td>@(msOrder++)</td>
                                        <td>
                                            <strong>@ms.Title</strong>
                                            @if (!string.IsNullOrEmpty(ms.Description))
                                            {
                                                <br /><small class="text-muted">@ms.Description</small>
                                            }
                                        </td>
                                        <td>@ms.DueDate.ToString("dd.MM.yyyy")</td>
                                        <td>
                                            @if (isCompleted)
                                            {
                                                <span class="badge bg-success">–í—ã–ø–æ–ª–Ω–µ–Ω</span>
                                            }
                                            else if (isOverdue)
                                            {
                                                <span class="badge bg-danger">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <!-- Payments -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cash-stack me-2"></i>–ü–ª–∞—Ç–µ–∂–∏</h5>
                    <span class="badge bg-secondary">@Model.Payments.Count –ø–ª–∞—Ç–µ–∂–µ–π</span>
                </div>
                <div class="card-body p-0">
                    @if (Model.Payments.Any())
                    {
                        var isTjsContract = Model.Currency == ContractCurrency.TJS && Model.ExchangeRate.HasValue;
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                    @if (isTjsContract)
                                    {
                                        <th class="text-end">–°—É–º–º–∞ (TJS)</th>
                                        <th class="text-end">–ö—É—Ä—Å</th>
                                        <th class="text-end">USD (–∫–æ–Ω—Ç—Ä–∞–∫—Ç)</th>
                                        <th class="text-end">USD (–æ–ø–ª–∞—Ç–∞)</th>
                                        <th class="text-end">–†–∞–∑–Ω–∏—Ü–∞</th>
                                    }
                                    else
                                    {
                                        <th class="text-end">–°—É–º–º–∞</th>
                                    }
                                    <th class="text-center">–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var payment in Model.Payments.OrderByDescending(p => p.PaymentDate))
                                {
                                    <tr>
                                        <td>@payment.PaymentDate.ToString("dd.MM.yyyy")</td>
                                        <td>@payment.Description</td>
                                        @if (isTjsContract)
                                        {
                                            var usdContract2 = (decimal?)null;
                                            var usdPayment2 = (decimal?)null;
                                            var diff2 = (decimal?)null;
                                            if (payment.AmountTjs.HasValue && payment.AmountTjs > 0)
                                            {
                                                if (Model.ExchangeRate!.Value > 0)
                                                    usdContract2 = Math.Round(payment.AmountTjs.Value / Model.ExchangeRate.Value, 2);
                                                if (payment.ExchangeRate.HasValue && payment.ExchangeRate > 0)
                                                    usdPayment2 = Math.Round(payment.AmountTjs.Value / payment.ExchangeRate.Value, 2);
                                                if (usdContract2.HasValue && usdPayment2.HasValue)
                                                    diff2 = usdPayment2.Value - usdContract2.Value;
                                            }
                                            <td class="text-end fw-semibold">
                                                @if (payment.AmountTjs.HasValue && payment.AmountTjs > 0)
                                                {
                                                    @payment.AmountTjs.Value.ToString("N2") <small class="text-muted">TJS</small>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">‚Äî</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (payment.ExchangeRate.HasValue)
                                                {
                                                    @payment.ExchangeRate.Value.ToString("F4")
                                                }
                                                else
                                                {
                                                    <span class="text-muted">‚Äî</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (usdContract2.HasValue)
                                                {
                                                    <span>$@usdContract2.Value.ToString("N2")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">‚Äî</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (usdPayment2.HasValue)
                                                {
                                                    <span>$@usdPayment2.Value.ToString("N2")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">‚Äî</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (diff2.HasValue && diff2 != 0)
                                                {
                                                    <span class="fw-semibold @(diff2 > 0 ? "text-success" : "text-danger")">
                                                        @(diff2 > 0 ? "‚ñ≤" : "‚ñº") $@Math.Abs(diff2.Value).ToString("N2")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">‚Äî</span>
                                                }
                                            </td>
                                        }
                                        else
                                        {
                                            <td class="text-end fw-semibold">$@payment.Amount.ToString("N0")</td>
                                        }
                                        <td class="text-center">
                                            @switch (payment.Status)
                                            {
                                                case PaymentStatus.Pending:
                                                    <span class="badge bg-warning text-dark">–û–∂–∏–¥–∞–µ—Ç</span>
                                                    break;
                                                case PaymentStatus.Approved:
                                                    <span class="badge bg-info">–û–¥–æ–±—Ä–µ–Ω</span>
                                                    break;
                                                case PaymentStatus.Paid:
                                                    <span class="badge bg-success">–û–ø–ª–∞—á–µ–Ω</span>
                                                    break;
                                                case PaymentStatus.Rejected:
                                                    <span class="badge bg-danger">–û—Ç–∫–ª–æ–Ω—ë–Ω</span>
                                                    break;
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            –ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π
                        </div>
                    }
                </div>
            </div>

            <!-- Documents (3 tabs) -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-folder2-open me-2"></i>–î–æ–∫—É–º–µ–Ω—Ç—ã</h5>
                </div>
                <div class="card-body">
                    @{ 
                        var signedDocs = Model.Documents.Where(d => d.Type == DocumentType.SignedContract).ToList();
                        var mandatoryDocs = Model.Documents.Where(d => d.Type == DocumentType.MandatoryDocument).ToList();
                        var additionalDocs = Model.Documents.Where(d => d.Type == DocumentType.AdditionalDocument).ToList();
                    }
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#detailSigned" type="button" role="tab">
                                <i class="bi bi-file-earmark-check me-1"></i>–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                                @if (signedDocs.Any()) { <span class="badge bg-primary ms-1">@signedDocs.Count</span> }
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detailMandatory" type="button" role="tab">
                                <i class="bi bi-file-earmark-lock me-1"></i>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
                                @if (mandatoryDocs.Any()) { <span class="badge bg-warning text-dark ms-1">@mandatoryDocs.Count</span> }
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detailAdditional" type="button" role="tab">
                                <i class="bi bi-file-earmark-plus me-1"></i>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
                                @if (additionalDocs.Any()) { <span class="badge bg-info ms-1">@additionalDocs.Count</span> }
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3">
                        <div class="tab-pane fade show active" id="detailSigned" role="tabpanel">
                            @if (signedDocs.Any())
                            {
                                <ul class="list-unstyled mb-0">
                                    @foreach (var doc in signedDocs)
                                    {
                                        <li class="mb-2">
                                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                            <a href="@doc.FilePath" target="_blank">@(doc.Description ?? doc.OriginalFileName)</a>
                                            <small class="text-muted ms-2">@(doc.FileSize / 1024) KB</small>
                                        </li>
                                    }
                                </ul>
                            }
                            else { <p class="text-muted mb-0 text-center"><i class="bi bi-inbox me-1"></i>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p> }
                        </div>
                        <div class="tab-pane fade" id="detailMandatory" role="tabpanel">
                            @if (mandatoryDocs.Any())
                            {
                                <ul class="list-unstyled mb-0">
                                    @foreach (var doc in mandatoryDocs)
                                    {
                                        <li class="mb-2">
                                            <i class="bi bi-file-earmark-text text-warning me-2"></i>
                                            <a href="@doc.FilePath" target="_blank">@(doc.Description ?? doc.OriginalFileName)</a>
                                            <small class="text-muted ms-2">@(doc.FileSize / 1024) KB</small>
                                        </li>
                                    }
                                </ul>
                            }
                            else { <p class="text-muted mb-0 text-center"><i class="bi bi-inbox me-1"></i>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p> }
                        </div>
                        <div class="tab-pane fade" id="detailAdditional" role="tabpanel">
                            @if (additionalDocs.Any())
                            {
                                <ul class="list-unstyled mb-0">
                                    @foreach (var doc in additionalDocs)
                                    {
                                        <li class="mb-2">
                                            <i class="bi bi-file-earmark text-info me-2"></i>
                                            <a href="@doc.FilePath" target="_blank">@(doc.Description ?? doc.OriginalFileName)</a>
                                            <small class="text-muted ms-2">@(doc.FileSize / 1024) KB</small>
                                        </li>
                                    }
                                </ul>
                            }
                            else { <p class="text-muted mb-0 text-center"><i class="bi bi-inbox me-1"></i>–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p> }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Contractor Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>–ü–æ–¥—Ä—è–¥—á–∏–∫</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold">@Model.Contractor.Name</h6>
                    @if (!string.IsNullOrEmpty(Model.Contractor.Country))
                    {
                        <p class="mb-1"><i class="bi bi-geo-alt me-2"></i>@Model.Contractor.Country</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Contractor.ContactPerson))
                    {
                        <p class="mb-1"><i class="bi bi-person me-2"></i>@Model.Contractor.ContactPerson</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Contractor.Email))
                    {
                        <p class="mb-1"><i class="bi bi-envelope me-2"></i><a href="mailto:@Model.Contractor.Email">@Model.Contractor.Email</a></p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Contractor.Phone))
                    {
                        <p class="mb-0"><i class="bi bi-telephone me-2"></i>@Model.Contractor.Phone</p>
                    }
                </div>
            </div>

            <!-- Financial Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>–§–∏–Ω–∞–Ω—Å—ã</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless mb-0">
                        @if (Model.Currency == ContractCurrency.TJS && Model.AmountTjs.HasValue)
                        {
                            <tr>
                                <td class="text-muted">–í–∞–ª—é—Ç–∞:</td>
                                <td class="text-end"><span class="badge bg-info-subtle text-info-emphasis">üáπüáØ TJS</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted">–°—É–º–º–∞ (TJS):</td>
                                <td class="text-end fw-bold">@Model.AmountTjs.Value.ToString("N2") TJS</td>
                            </tr>
                            @if (Model.ExchangeRate.HasValue)
                            {
                                <tr>
                                    <td class="text-muted">–ö—É—Ä—Å –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è:</td>
                                    <td class="text-end">@Model.ExchangeRate.Value.ToString("F4")</td>
                                </tr>
                            }
                            <tr>
                                <td class="text-muted">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç (USD):</td>
                                <td class="text-end">$@Model.ContractAmount.ToString("N2")</td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td class="text-muted">–°—É–º–º–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:</td>
                                <td class="text-end">$@Model.ContractAmount.ToString("N0")</td>
                            </tr>
                        }
                        @if (Model.AdditionalAmount > 0)
                        {
                            <tr>
                                <td class="text-muted">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</td>
                                <td class="text-end text-success">+$@Model.AdditionalAmount.ToString("N0")</td>
                            </tr>
                        }
                        @if (Model.SavedAmount > 0)
                        {
                            <tr>
                                <td class="text-muted">–≠–∫–æ–Ω–æ–º–∏—è:</td>
                                <td class="text-end text-info">-$@Model.SavedAmount.ToString("N0")</td>
                            </tr>
                        }
                        <tr class="border-top">
                            <td class="fw-bold">–ò—Ç–æ–≥–æ (USD):</td>
                            <td class="text-end fw-bold">$@Model.FinalAmount.ToString("N0")</td>
                        </tr>
                        <tr>
                            <td class="text-muted">–û–ø–ª–∞—á–µ–Ω–æ:</td>
                            <td class="text-end text-success">$@Model.PaidAmount.ToString("N0")</td>
                        </tr>
                        @if (Model.Currency == ContractCurrency.TJS && Model.ExchangeRate.HasValue)
                        {
                            var paidPayments = Model.Payments.Where(p => p.Status == PaymentStatus.Paid && p.AmountTjs.HasValue && p.AmountTjs > 0).ToList();
                            if (paidPayments.Any())
                            {
                                var contractRate = Model.ExchangeRate.Value;
                                var totalUsdAtContractRate = paidPayments.Where(p => contractRate > 0).Sum(p => Math.Round(p.AmountTjs!.Value / contractRate, 2));
                                var totalUsdAtPaymentRate = paidPayments.Where(p => p.ExchangeRate.HasValue && p.ExchangeRate > 0).Sum(p => Math.Round(p.AmountTjs!.Value / p.ExchangeRate!.Value, 2));
                                var gainLoss = totalUsdAtPaymentRate - totalUsdAtContractRate;
                                if (gainLoss != 0)
                                {
                                    <tr>
                                        <td class="text-muted">–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–∑–Ω–∏—Ü–∞:</td>
                                        <td class="text-end fw-semibold @(gainLoss > 0 ? "text-success" : "text-danger")">
                                            @(gainLoss > 0 ? "‚ñ≤" : "‚ñº") $@Math.Abs(gainLoss).ToString("N2")
                                        </td>
                                    </tr>
                                }
                            }
                        }
                        <tr>
                            <td class="text-muted">–ö –æ–ø–ª–∞—Ç–µ:</td>
                            <td class="text-end text-warning">$@Model.RemainingAmount.ToString("N0")</td>
                        </tr>
                    </table>
                </div>
            </div>

        </div>
    </div>

    @* ========= Amendments History ========= *@
    @if (Model.Amendments.Any())
    {
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ø—Ä–∞–≤–æ–∫ <span class="badge bg-warning text-dark ms-2">@Model.Amendments.Count</span></h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>‚Ññ</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã</th>
                                <th>–ù–æ–≤—ã–π —Å—Ä–æ–∫</th>
                                <th>–î–æ–∫—É–º–µ–Ω—Ç—ã</th>
                                @if (canDeleteAmendment)
                                {
                                    <th></th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @{ var amendIdx = 0; }
                            @foreach (var a in Model.Amendments.OrderBy(x => x.AmendmentDate))
                            {
                                amendIdx++;
                                <tr>
                                    <td>@amendIdx</td>
                                    <td class="text-nowrap">@a.AmendmentDate.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        @switch (a.Type)
                                        {
                                            case AmendmentType.AmountChange:
                                                <span class="badge bg-success">–°—É–º–º–∞</span>
                                                break;
                                            case AmendmentType.DeadlineExtension:
                                                <span class="badge bg-info">–°—Ä–æ–∫</span>
                                                break;
                                            case AmendmentType.ScopeChange:
                                                <span class="badge bg-purple" style="background-color: #6f42c1 !important;">–û–±—ä—ë–º</span>
                                                break;
                                        }
                                    </td>
                                    <td>@(a.Description ?? "‚Äî")</td>
                                    <td class="text-nowrap">
                                        @if (a.AmountChangeUsd.HasValue)
                                        {
                                            <span class="text-success fw-semibold">+$@a.AmountChangeUsd.Value.ToString("N0")</span>
                                            @if (a.AmountChangeTjs.HasValue)
                                            {
                                                <br/><small class="text-muted">@a.AmountChangeTjs.Value.ToString("N0") TJS</small>
                                            }
                                        }
                                        else
                                        {
                                            <span class="text-muted">‚Äî</span>
                                        }
                                    </td>
                                    <td class="text-nowrap">
                                        @if (a.NewEndDate.HasValue)
                                        {
                                            <span>@a.NewEndDate.Value.ToString("dd.MM.yyyy")</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">‚Äî</span>
                                        }
                                    </td>
                                    <td>
                                        @foreach (var doc in a.Documents)
                                        {
                                            <a href="@doc.FilePath" target="_blank" class="d-block small">
                                                <i class="bi bi-file-earmark-pdf text-danger me-1"></i>@(doc.Description ?? doc.OriginalFileName)
                                            </a>
                                        }
                                        @if (!a.Documents.Any())
                                        {
                                            <span class="text-muted">‚Äî</span>
                                        }
                                    </td>
                                    @if (canDeleteAmendment)
                                    {
                                        <td>
                                            <form asp-action="DeleteAmendment" asp-route-id="@a.Id" method="post"
                                                  onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–ø—Ä–∞–≤–∫—É? –ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–º–µ–Ω–µ–Ω—ã.');">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@* ========= Amendment Modal ========= *@
@if (canAmend)
{
<div class="modal fade" id="amendmentModal" tabindex="-1" aria-labelledby="amendmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateAmendment" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ContractId" value="@Model.Id" />
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title" id="amendmentModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ø—Ä–∞–≤–∫—É –∫ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">–¢–∏–ø –ø–æ–ø—Ä–∞–≤–∫–∏ <span class="text-danger">*</span></label>
                            <select name="Type" id="amendmentType" class="form-select" required>
                                <option value="0">üí∞ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</option>
                                <option value="1">üìÖ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</option>
                                <option value="2">üìã –ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ —É—Å–ª—É–≥</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">–î–∞—Ç–∞ –ø–æ–ø—Ä–∞–≤–∫–∏ <span class="text-danger">*</span></label>
                            <input type="date" name="AmendmentDate" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea name="Description" class="form-control" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ø—Ä–∞–≤–∫–∏..."></textarea>
                        </div>
                    </div>

                    <!-- Amount fields (Type 0 & 2) -->
                    <div id="amountFields" class="mt-3">
                        <h6 class="border-bottom pb-2 text-success"><i class="bi bi-cash-stack me-1"></i>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É–º–º—ã</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">–°—É–º–º–∞ (TJS)</label>
                                <input type="number" name="AmountChangeTjs" id="amtTjs" class="form-control" step="0.01" 
                                       placeholder="0.00" oninput="convertToUsd()" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–ö—É—Ä—Å (USD/TJS)</label>
                                <input type="number" name="ExchangeRate" id="amtRate" class="form-control" step="0.0001" 
                                       value="@(Model.ExchangeRate?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")" oninput="convertToUsd()" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç (USD)</label>
                                <input type="number" name="AmountChangeUsd" id="amtUsd" class="form-control" step="0.01" readonly 
                                       style="background-color: #e9ecef;" />
                            </div>
                        </div>
                    </div>

                    <!-- Date fields (Type 1 & 2) -->
                    <div id="dateFields" class="mt-3" style="display: none;">
                        <h6 class="border-bottom pb-2 text-info"><i class="bi bi-calendar-plus me-1"></i>–ü—Ä–æ–¥–ª–µ–Ω–∏–µ —Å—Ä–æ–∫–∞</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" class="form-control" readonly 
                                       value="@((Model.ExtendedToDate ?? Model.ContractEndDate).ToString("yyyy-MM-dd"))"
                                       style="background-color: #e9ecef;" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" name="NewEndDate" id="newEndDate" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <!-- Scope fields (Type 2 only) -->
                    <div id="scopeFields" class="mt-3" style="display: none;">
                        <h6 class="border-bottom pb-2" style="color: #6f42c1;"><i class="bi bi-list-check me-1"></i>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ —Ä–∞–±–æ—Ç</h6>
                        <div>
                            <label class="form-label">–ù–æ–≤—ã–π –æ–±—ä—ë–º —Ä–∞–±–æ—Ç</label>
                            <textarea name="NewScopeOfWork" class="form-control" rows="3" 
                                      placeholder="–û–ø–∏—à–∏—Ç–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –æ–±—ä—ë–º...">@Model.ScopeOfWork</textarea>
                        </div>
                    </div>

                    <!-- Documents -->
                    <div class="mt-3">
                        <h6 class="border-bottom pb-2 text-secondary"><i class="bi bi-paperclip me-1"></i>–î–æ–∫—É–º–µ–Ω—Ç—ã</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ <span class="text-danger">*</span></label>
                                <input type="file" name="AgreementFile" class="form-control" required />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
                                <input type="text" name="AgreementName" class="form-control" value="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ" />
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</label>
                            <div id="amendmentDocsContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="addAmendmentDocRow()">
                                <i class="bi bi-plus-circle me-1"></i>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-lg me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ø—Ä–∞–≤–∫—É
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Toggle amendment form sections based on type
    document.getElementById('amendmentType').addEventListener('change', function() {
        var type = parseInt(this.value);
        var amountFields = document.getElementById('amountFields');
        var dateFields = document.getElementById('dateFields');
        var scopeFields = document.getElementById('scopeFields');
        
        amountFields.style.display = (type === 0 || type === 2) ? 'block' : 'none';
        dateFields.style.display = (type === 1 || type === 2) ? 'block' : 'none';
        scopeFields.style.display = (type === 2) ? 'block' : 'none';
    });
    
    // Convert TJS to USD
    function convertToUsd() {
        var tjs = parseFloat(document.getElementById('amtTjs').value) || 0;
        var rate = parseFloat(document.getElementById('amtRate').value) || 0;
        var usdField = document.getElementById('amtUsd');
        if (tjs > 0 && rate > 0) {
            usdField.value = (tjs / rate).toFixed(2);
        } else {
            usdField.value = '';
        }
    }
    
    // Add additional document row
    var amendDocIdx = 0;
    function addAmendmentDocRow() {
        var container = document.getElementById('amendmentDocsContainer');
        var row = document.createElement('div');
        row.className = 'row g-2 mb-2 align-items-end';
        row.innerHTML = `
            <div class="col-5">
                <input type="file" name="AdditionalFiles" class="form-control form-control-sm" />
            </div>
            <div class="col-5">
                <input type="text" name="AdditionalNames" class="form-control form-control-sm" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞" />
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.row').remove()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        `;
        container.appendChild(row);
    }
</script>
}
